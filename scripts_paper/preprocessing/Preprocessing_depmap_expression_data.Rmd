---
title: "Preprocessing DepMap data"
author: "Joke Deschildre"
date: "17 maart 2021"
output: html_document
version: "R version 4.0.3 (2020-10-10) -- Bunny-Wunnies Freak Out"
---
```{r}
library(data.table)
library(limma)
library(stringr)
library(edgeR)
library(ggplot2)
```


#Preprocessing of the needed DepMap expression data

##Brain data
In the overlap_celllines.Rmd script the usable central nervous system or brain cell lines were determined, the according expression data was saved in a seperate file and this expression (count) data is now preprocessed. 

Read in the data, remove unwanted columns, print the dimension:

```{r}
brain_expr_t <- fread("../selection_brain_expression_data.csv", data.table=F)
#brain_expr_t[,1] <- NULL #--> not needed when using fwrite funtion in overlap cellines script
rownames(brain_expr_t) <- brain_expr_t[,1]
brain_expr_t[,1] <- NULL
print(head(brain_expr_t))
print(paste("dimension: ", paste(dim(brain_expr_t), collapse=" x ")))
```
The sample info for the brain cell lines: to explore outlier cell lines. 
```{r}
sample_info <- read.csv('../20Q4 v2/20Q4_v2_sample_info.csv', header=TRUE, sep=",", fill=TRUE)
sample_info_brain <- sample_info[sample_info$DepMap_ID %in% rownames(brain_expr_t),]
sample_info_brain
```

Transpose the data and make achilles cell lines identifiers shorter (for MDS plotting): 
```{r}
brain_expr <- t(brain_expr_t) # transpose 
print(paste("dimension: ", paste(dim(brain_expr), collapse=" x ")))
colnames(brain_expr) <- lapply(colnames(brain_expr), function(x) str_remove(x, "ACH-00"))
```

Search for NAs in the data --> no present 
```{r}
sum(is.na(brain_expr))
```
Making a DGEList (with edgeR package) of the data and removing genes with low read count. Library size is NOT kept the same. calcNormFactors is used: "The calcNormFactors function normalizes for RNA composition by finding a set of scaling factors for the library sizes that minimize the log-fold changes between the samples for most genes." Eventually the data is logscaled and the counts per million are taken (instead of original counts).
```{r}
brain_expr_DGE  <- DGEList(brain_expr)
keep <- rowSums(cpm(brain_expr_DGE)>1) >= 1 # select all genes for which the counts per million read count is below 1 (for all cellines) 
print("amount of genes removed (FALSE) and kept (TRUE):")
print(table(keep))
brain_expr_DGE<- brain_expr_DGE[keep, , keep.lib.sizes=FALSE] #delete all above selected genes #keep.lib.sizes=false --> normalise on library size
brain_expr_DGE <- calcNormFactors(brain_expr_DGE)
brain_expr_DGE <- cpm(brain_expr_DGE, log = TRUE, prior.count=1) # prior.count = "average count to be added to each observation to avoid taking log of zero. Used only if log=TRUE"
print(paste("dimension: ", paste(dim(brain_expr_DGE), collapse=" x ")))
```
Plot the MDS plot 
```{r}
#jpeg('MDSplot_brain_data_1.jpeg')
plotMDS(brain_expr_DGE, xlab="Dimension 1", ylab="Dimension 2")
#dev.off
```

Only keeping the highly variable genes. We take 2 cutoffs here: a stringent cutoff at 2.75 and a less stringen cutoff at 0.5. Both are determined at points in the variance histogram graph where there is a strong drop between two consecutive bars. Both are stored and saved at the end of this script, we will likely use the more stringent cut-off to limit the following running times and network sizes. 
```{r}
brain_expr_variance <- apply(brain_expr_DGE, 1, var) # calculate the variance per gene

#png("y_brain_variance_histogram.png")
ggplot(data.frame(brain_expr_variance), aes(x=brain_expr_variance))+ geom_histogram(binwidth=0.25, colour="black", fill="white", boundary=0) + geom_vline(xintercept= 2.75, color='red', size=1) + xlab('variances') + ylab('frequency')
#dev.off 

brain_expr_var_0_5 <- brain_expr_DGE[brain_expr_variance>0.5,]  
print(paste("dimension with cut-off 0.5: ", paste(dim(brain_expr_var_0_5), collapse=" x ")))
brain_expr_var_2_75 <- brain_expr_DGE[brain_expr_variance>2.75,]  
print(paste("dimension with cut-off 2.75: ", paste(dim(brain_expr_var_2_75), collapse=" x ")))
```


centering and scaling: 
```{r}
# (0.5 cut off)
print("mean before")
print(apply(brain_expr_var_0_5[1:15,], 1, mean)) # as control 
print("var before")  
print(apply(brain_expr_var_0_5[1:15,], 1, sd)) # as control 
brain_expr_scaled_0_5 <- t(scale(t(brain_expr_var_0_5), center= TRUE, scale=TRUE))
print("mean after")
print(apply(brain_expr_scaled_0_5[1:15,], 1, mean)) # as control 
print("var after")
print(apply(brain_expr_scaled_0_5[1:15,], 1, sd)) # as control
# Plots control of scaling 
qplot(brain_expr_scaled_0_5[,5], geom="histogram")
qplot(brain_expr_var_0_5[,5], geom="histogram")
qplot((brain_expr_scaled_0_5)[,5], geom="density")
print(paste("dimension: ", paste(dim(brain_expr_scaled_0_5), collapse=" x ")))

#(2.75 cut off)
print("mean before")
print(apply(brain_expr_var_2_75[1:15,], 1, mean)) # as control 
print("var before")  
print(apply(brain_expr_var_2_75[1:15,], 1, sd)) # as control 
brain_expr_scaled_2_75 <- t(scale(t(brain_expr_var_2_75), center= TRUE, scale=TRUE))
print("mean after")
print(apply(brain_expr_scaled_2_75[1:15,], 1, mean)) # as control 
print("var after")
print(apply(brain_expr_scaled_2_75[1:15,], 1, sd)) # as control
# Plots control of scaling 
qplot(brain_expr_scaled_2_75[,5], geom="histogram")
qplot(brain_expr_var_2_75[,5], geom="histogram")
qplot((brain_expr_scaled_2_75)[,5], geom="density")
print(paste("dimension: ", paste(dim(brain_expr_scaled_2_75), collapse=" x ")))
```
```{r}
#jpeg('MDSplot_brain_data_0_5.jpeg')
plotMDS(brain_expr_scaled_0_5, xlab="Dimension 1", ylab="Dimension 2")
#dev.off
#jpeg('MDSplot_brain_data_2_75.jpeg')
plotMDS(brain_expr_scaled_2_75, xlab="Dimension 1", ylab="Dimension 2") #RESEMBLES BETTER TO ORIGINAL DMP 
#dev.off
```

Put the preprocessing in a function 
```{r}
DepMap_preprocessing_function_part1 <- function(expression_data_dir, tissue, figures_to_files=FALSE){
  # Read in the data, remove unwanted columns, print the dimension:
  expr_t <- fread(expression_data_dir, data.table=F)
  #expr_t[,1] <- NULL #--> not needed when using fwrite funtion in overlap cellines script
  rownames(expr_t) <- expr_t[,1]
  expr_t[,1] <- NULL
  print(paste("dimension original expression data: ", paste(dim(expr_t), collapse=" x ")))
  #transpose and make cell line names shorter
  expr <- t(expr_t) # transpose 
  print(paste("dimension transposed expression data: ", paste(dim(expr), collapse=" x ")))
  colnames(expr) <- lapply(colnames(expr), function(x) str_remove(x, "ACH-00"))
  # if NAs are present these are set to zero THIS IS HOWEVER NOT BEST PRACTICE: see preprocessing GitHub file Jens; a warning is then given
  if(sum(is.na(expr))){
    expr[is.na(expr)] <- 0
  }
  #Making a DGEList, removing genes with low read count, Library normalization,logscaling, cpm count .
  expr_DGE  <- DGEList(expr)
  keep <- rowSums(cpm(expr_DGE)>1) >= 1 # select all genes for which the counts per million read count is below 1 (for all cellines) 
  expr_DGE<- expr_DGE[keep, , keep.lib.sizes=FALSE] #delete all above selected genes #keep.lib.sizes=false --> normalise on library size
  expr_DGE <- calcNormFactors(expr_DGE)
  expr_DGE <- cpm(expr_DGE, log = TRUE, prior.count=1) # prior.count = "average count to be added to each observation to avoid taking log of zero
  print(paste("dimension after normalisation for lib size and : ", paste(dim(expr_DGE), collapse=" x ")))
  
  #plot MDS plot
  plotMDS(expr_DGE, xlab="Dimension 1", ylab="Dimension 2")
  if (figures_to_files==TRUE){
    jpeg(paste('MDSplot_partially_preprocessed_', tissue, '_data.jpeg', sep=''))
    plotMDS(expr_DGE, xlab="Dimension 1", ylab="Dimension 2")
    dev.off()
  }
  expr_variance <- apply(expr_DGE, 1, var) # calculate the variance per gene
  p <- ggplot(data.frame(expr_variance), aes(x=expr_variance))+ geom_histogram(binwidth=0.25, colour="black", fill="white", boundary=0) + xlab('variances') + ylab('frequency')
  plot(p)
  
  if (figures_to_files==TRUE){
    jpeg(paste('variance_plot_', tissue, '_data.jpeg', sep=''))
    print(p)
    dev.off()
  }
  return(expr_DGE)
}
####################################################################################
DepMap_preprocessing_function_part2 <- function(expr_DGE, tissue, var_cutoff, figures_to_files=FALSE){
  expr_variance <- apply(expr_DGE, 1, var) # calculate the variance per gene

  p <- ggplot(data.frame(expr_variance), aes(x=expr_variance))+ geom_histogram(binwidth=0.25, colour="black", fill="white", boundary=0) + xlab('variances') + ylab('frequency') + geom_vline(xintercept= var_cutoff, color='red', size=1)
  plot(p)
    
  if (figures_to_files==TRUE){
    jpeg(paste('variance_plot_with_cutoff_', tissue, '_', var_cutoff,'_data.jpeg', sep=''))
    print(p)
    dev.off()
  }
  expr_var <- expr_DGE[expr_variance>var_cutoff,]  
  print(paste("dimension after low variant gene removal: ", paste(dim(expr_var), collapse=" x ")))
  
  expr_scaled <- t(scale(t(expr_var), center= TRUE, scale=TRUE))
  
  print(paste("final dimension: ", paste(dim(expr_scaled), collapse=" x ")))
  
  plotMDS(expr_scaled, xlab="Dimension 1", ylab="Dimension 2")
  if (figures_to_files==TRUE){
    jpeg(paste('MDSplot_final_', tissue,'_', var_cutoff, '_data.jpeg', sep=''))
    plotMDS(expr_scaled, xlab="Dimension 1", ylab="Dimension 2")
    dev.off()
  }
  return(expr_scaled)
}
```
tryout the functions 
```{r}
expr_DGE_function_brain <- DepMap_preprocessing_function_part1( "../selection_brain_expression_data.csv", "brain", figures_to_files = T)
```

```{r}
# (0.5 cut off)
expr_scaled_function_brain_0_5 <- DepMap_preprocessing_function_part2(expr_DGE_function_brain, "brain", 0.5, figures_to_files = T)
all.equal(expr_scaled_function_brain_0_5 , brain_expr_scaled_0_5)
#write.csv(expr_scaled_function_brain_0_5, "JDS_brain_expression_0_5_var.csv", col.names = T, row.names = T)
expr_scaled_function_brain_0_5_only_names <- expr_scaled_function_brain_0_5
rownames(expr_scaled_function_brain_0_5_only_names) <- str_remove(rownames(expr_scaled_function_brain_0_5), ' ')
#write.csv(expr_scaled_function_brain_0_5_only_names, "JDS_brain_expression_0_5_var_only_names.csv", col.names = T, row.names = T)

# (2.75 cut off)
expr_scaled_function_brain_2_75 <- DepMap_preprocessing_function_part2(expr_DGE_function_brain, "brain", 2.75, figures_to_files = T)
all.equal(expr_scaled_function_brain_2_75, brain_expr_scaled_2_75)
#write.csv(expr_scaled_function_brain_2_75, "JDS_brain_expression_2_75_var.csv", col.names = T, row.names = T)
expr_scaled_function_brain_2_75_only_names <- expr_scaled_function_brain_2_75
rownames(expr_scaled_function_brain_2_75_only_names) <- str_remove(rownames(expr_scaled_function_brain_2_75), ' ')
#write.csv(expr_scaled_function_brain_2_75_only_names, "JDS_brain_expression_2_75_var_only_names.csv", col.names = T, row.names = T)
```
```{r}
#expr_scaled_function_brain_2_75 
```

are the gene names unique? (YES for 2.75, NO for 0.5 --> best to use ID's !! )
```{r}
length(unique(rownames(expr_scaled_function_brain_0_5)))
length(rownames(expr_scaled_function_brain_0_5))
length(unique(str_remove(rownames(expr_scaled_function_brain_0_5), ' ')))
length(unique(str_remove(rownames(expr_scaled_function_brain_0_5), ' \\(ENSG[0-9]+\\)'))) # there are a few genes with the same gene names 

length(unique(rownames(expr_scaled_function_brain_2_75)))
length(rownames(expr_scaled_function_brain_2_75))
length(unique(str_remove(rownames(expr_scaled_function_brain_2_75), ' ')))
length(unique(str_remove(rownames(expr_scaled_function_brain_2_75), ' \\(ENSG[0-9]+\\)')))
```


Control for NA values that will appear in the LIONESS & PCC methods 
The LIONESS and SSN methods give NA values for all edges including certain genes (for certain samples). These genes appear to have a variance of zero in their expression data, when not taking the certain sample of interest into account. In other words, the expression value is the same in all samples for this gene except for the sample of interest. 
```{r}
NA_indices <- function(expression_data_frame){
  NA_genes_ind <- c()
  for (i in 1:dim(expression_data_frame)[2]){
    var <- apply(expression_data_frame[,-i], 1, var)
    NA_genes_ind <- c(NA_genes_ind, which(var==0))
  }
  return(NA_genes_ind)
}

NA_indices(expr_scaled_function_brain_2_75) #zero so there will be no NA values 
NA_indices(expr_scaled_function_brain_0_5) #zero so there will be no NA values 
```
Now for lung data 
```{r}
lung_expr_t <- fread("../selection_lung_expression_data.csv", data.table=F)
rownames(lung_expr_t) <- lung_expr_t[,1]
lung_expr_t[,1] <- NULL
print(head(lung_expr_t))
print(paste("dimension: ", paste(dim(lung_expr_t), collapse=" x ")))
```



```{r}
expr_DGE_function_lung <- DepMap_preprocessing_function_part1( "../selection_lung_expression_data.csv", "lung", figures_to_files = T)
# (0.5 cut off)
```

```{r}

expr_scaled_function_lung_0_75 <- DepMap_preprocessing_function_part2(expr_DGE_function_lung, "brain", 2.75, figures_to_files = T)

write.csv(expr_scaled_function_lung_0_75, "JDS_lung_expression_2_75_var.csv", col.names = T, row.names = T)
expr_scaled_function_lung_0_75_only_names <- expr_scaled_function_lung_0_75
rownames(expr_scaled_function_lung_0_75_only_names) <- str_remove(rownames(expr_scaled_function_lung_0_75), ' ')
write.csv(expr_scaled_function_lung_0_75_only_names, "JDS_lung_expression_2_75_var_only_names.csv", col.names = T, row.names = T)
expr_scaled_function_lung_0_75_only_ensembl <- expr_scaled_function_lung_0_75
rownames(expr_scaled_function_lung_0_75_only_ensembl) <- str_remove(rownames(expr_scaled_function_lung_0_75_only_ensembl), '^[A-Za-z0-9\\.\\-\\_]* \\(')
rownames(expr_scaled_function_lung_0_75_only_ensembl) <- str_remove(rownames(expr_scaled_function_lung_0_75_only_ensembl) , '\\)$')
write.csv(expr_scaled_function_lung_0_75_only_ensembl, "JDS_lung_expression_2_75_var_only_ensembl.csv", col.names = T, row.names = T)
```
Control for NA values that will appear in the LIONESS & PCC methods 
The LIONESS and SSN methods give NA values for all edges including certain genes (for certain samples). These genes appear to have a variance of zero in their expression data, when not taking the certain sample of interest into account. In other words, the expression value is the same in all samples for this gene except for the sample of interest. 
```{r}
NA_indices(expr_scaled_function_lung_0_75) #zero so there will be no NA values 
```
